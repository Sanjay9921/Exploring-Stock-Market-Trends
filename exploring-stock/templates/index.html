<!-- templates/index.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Exploring Stock Market</title>
    <script src="https://cdn.plot.ly/plotly-2.29.1.min.js"></script>
    <style>
      body { font-family: system-ui, sans-serif; margin: 20px; }
      #controls { margin-bottom: 10px; }
      select { margin-right: 8px; }
      .portfolio-grid {
        display: flex;
        gap: 16px;
        margin-bottom: 20px;
      }
      .portfolio-card {
        flex: 1;
        min-width: 0;
      }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #ccc; padding: 4px 8px; text-align: right; }
      th { background: #f4f4f4; }
      td.label { text-align: left; }
    </style>
  </head>
  <body>

    <!--Exploring Stock Market using Plotly-->
    <h2>Exploring Stock Market</h2>

    <!--Portfolio summary-->
    <h3>Portfolio allocations</h3>

    <div class="portfolio-grid">
      <!-- Max‑Sharpe -->
      <div class="portfolio-card">
        <h4>Max‑Sharpe portfolio</h4>
        <table>
          <tr>
            <th class="label">Ticker</th>
            <th>Weight (%)</th>
          </tr>
          {% for ticker, w in allocations.max_sharpe.weights.items() %}
          <tr>
            <td class="label">{{ ticker }}</td>
            <td>{{ (w * 100) | round(2) }}</td>
          </tr>
          {% endfor %}
          <tr>
            <td class="label"><strong>Sharpe ratio</strong></td>
            <td><strong>{{ allocations.max_sharpe.sharpe | round(3) }}</strong></td>
          </tr>
        </table>
      </div>

      <!-- Min‑vol -->
      <div class="portfolio-card">
        <h4>Minimum‑volatility portfolio</h4>
        <table>
          <tr>
            <th class="label">Ticker</th>
            <th>Weight (%)</th>
          </tr>
          {% for ticker, w in allocations.min_vol.weights.items() %}
          <tr>
            <td class="label">{{ ticker }}</td>
            <td>{{ (w * 100) | round(2) }}</td>
          </tr>
          {% endfor %}
          <tr>
            <td class="label"><strong>Volatility</strong></td>
            <td><strong>{{ allocations.min_vol.volatility | round(3) }}</strong></td>
          </tr>
        </table>
      </div>

      <!-- 1/n benchmark -->
      <div class="portfolio-card">
        <h4>Equal‑weight benchmark (1/n)</h4>
        <p>
          Expected return:
          {{ allocations.benchmark.expected_return | round(4) }}<br>
          Sharpe ratio:
          {{ allocations.benchmark.sharpe | round(3) }}
        </p>
      </div>
    </div>

    <!-- Existing Plotly controls -->
    <div id="controls">
      <label>Ticker:
        <select id="ticker-select"></select>
      </label>
      <label>Metric:
        <select id="metric-select"></select>
      </label>
    </div>
    <div id="plot" style="width:95%;height:500px;"></div>

    <script>
      async function loadOptions() {
        const [tickRes, metRes] = await Promise.all([
          fetch("/api/tickers"),
          fetch("/api/metrics")
        ]);
        const tickers = (await tickRes.json()).tickers;
        const metrics = (await metRes.json()).metrics;

        const tSel = document.getElementById("ticker-select");
        const mSel = document.getElementById("metric-select");

        tickers.forEach(t => {
          const opt = document.createElement("option");
          opt.value = opt.textContent = t;
          tSel.appendChild(opt);
        });

        metrics.forEach(m => {
          const opt = document.createElement("option");
          opt.value = opt.textContent = m;
          mSel.appendChild(opt);
        });

        tSel.value = tickers[0];
        mSel.value = "close";

        tSel.onchange = () => loadFigure(tSel.value, mSel.value);
        mSel.onchange = () => loadFigure(tSel.value, mSel.value);

        loadFigure(tSel.value, mSel.value);
      }

      async function loadFigure(ticker, metric) {
        const res = await fetch(`/api/figure?ticker=${ticker}&metric=${metric}`);
        const fig = await res.json();
        Plotly.newPlot("plot", fig.data, fig.layout);
      }

      loadOptions();
    </script>
  </body>
</html>