<!-- templates/index.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Exploring Stock Market</title>
    <script src="https://cdn.plot.ly/plotly-2.29.1.min.js"></script>
    <style>
      body { font-family: system-ui, sans-serif; margin: 20px; }
      #controls { margin-bottom: 10px; }
      select { margin-right: 8px; }
    </style>
  </head>
  <body>
    <h2>Exploring Stock Market</h2>
    <div id="controls">
      <label>Ticker:
        <select id="ticker-select"></select>
      </label>
      <label>Metric:
        <select id="metric-select"></select>
      </label>
    </div>
    <div id="plot" style="width:95%;height:500px;"></div>

    <script>
      async function loadOptions() {
        const [tickRes, metRes] = await Promise.all([
          fetch("/api/tickers"),
          fetch("/api/metrics")
        ]);
        const tickers = (await tickRes.json()).tickers;
        const metrics = (await metRes.json()).metrics;

        const tSel = document.getElementById("ticker-select");
        const mSel = document.getElementById("metric-select");

        tickers.forEach(t => {
          const opt = document.createElement("option");
          opt.value = opt.textContent = t;
          tSel.appendChild(opt);
        });

        metrics.forEach(m => {
          const opt = document.createElement("option");
          opt.value = opt.textContent = m;
          mSel.appendChild(opt);
        });

        tSel.value = tickers[0];
        mSel.value = "close";

        tSel.onchange = () => loadFigure(tSel.value, mSel.value);
        mSel.onchange = () => loadFigure(tSel.value, mSel.value);

        loadFigure(tSel.value, mSel.value);
      }

      async function loadFigure(ticker, metric) {
        const res = await fetch(`/api/figure?ticker=${ticker}&metric=${metric}`);
        const fig = await res.json();
        Plotly.newPlot("plot", fig.data, fig.layout);
      }

      loadOptions();
    </script>
  </body>
</html>
